#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Run linting
echo "ğŸ“ Checking code style with Biome..."
if ! bun run lint; then
    echo "âŒ Linting failed! Please fix the issues above."
    exit 1
fi

# Check for debugging code in staged files (exclude .husky directory and config files)
echo "ğŸ” Checking for debugging code..."
STAGED_FILES=$(git diff --cached --name-only | grep -v "^\.husky/" | grep -v "\.config\." | grep -v "TEMPLATE")
if [ -n "$STAGED_FILES" ]; then
    if echo "$STAGED_FILES" | xargs grep -l "console\.log\|debugger" 2>/dev/null; then
        echo "âŒ Found debugging code in staged files:"
        echo "$STAGED_FILES" | xargs grep -n "console\.log\|debugger" 2>/dev/null || true
        echo "Please remove them before committing."
        exit 1
    fi
fi

# Optional: Run tests if they exist
if [ -f "package.json" ] && grep -q '"test"' package.json; then
    echo "ğŸ§ª Running tests..."
    if ! bun run test:run 2>/dev/null; then
        echo "âš ï¸  Tests not configured or failed. Skipping test check."
    fi
fi

# Check for type errors
echo "ğŸ” Checking for type errors..."
if ! bun run check-types; then
    echo "âŒ Type errors found! Please fix them before committing."
    exit 1
fi

echo "âœ… Pre-commit checks passed!"